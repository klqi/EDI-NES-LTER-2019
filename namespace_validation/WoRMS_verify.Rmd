---
title: "WoRMs_verify"
author: "Katherine Qi"
date: "6/21/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(taxonomyCleanr)
library(taxize)
library(worrms)
library(plyr)
library(dplyr)
```

## R Markdown
Set up taxonomy table built from inputted data set 

```{r}
man.data <- read.csv("20190529_classify_classlabel.csv")
my_path <- "~/Desktop/WHOI_LTER/projects/namespace_validation/"

```


## Script for using taxonomyCleanr package- not used

```{r}
taxa_map <- create_taxa_map(path = my_path, x = man.data, col = 'name')
output <- resolve_sci_taxa(path = my_path, data.sources = 9)

# compare output ids 
man.ids <- man.data$international_id
tclnr.ids <- taxa_map$authority_id
# man.ids$differences <- 
```

## Script for using taxize and worrms packages

```{r}

# Resolve names 
counter <- 28
man.data$resolved_names <- NA_character_
man.data$resolved_id <- NA_character_
for (row in 1:nrow(man.data)) {
  temp <- gnr_resolve(names = as.vector(man.data$name[counter]),  canonical = T,
                      best_match_only = T, preferred_data_sources = as.character(9))
  # check if resolved
  if (!empty(temp)) {
    # add to resolved_names column
    resolved_name <- temp[1, 'matched_name2']
    man.data$resolved_names[counter] <- resolved_name 
    # edge case: check if international_id exists in column
    if (man.data$international_id[counter] == -999 | is.na(man.data$international_id[counter])) {
      # man.data$resolved_id[counter] <- wm_name2id(name=unlist(man.data$resolved_names[counter]))
      response <- taxize::get_wormsid_(
        resolved_name,
        searchtype = 'scientific',
        accepted = F,
        ask = F,
        messages = F
      )
      response <- as.data.frame(response)
      resolved_name <- gsub(" ", ".", resolved_name, fixed=TRUE)
      get.id <- paste(resolved_name, sep='.', "AphiaID")
      resolved_id <- response[1, get.id]
      man.data$resolved_id[counter] <- resolved_id
    } else {
      # check worm ids with resolved names 
      test_name <- wm_id2name(id=man.data$international_id[counter])
      if (test_name == man.data$resolved_names[counter]) {
        # fill in with id from original international_id
        man.data$resolved_id[counter] <- man.data$international_id[counter]
      } else {
        # else fill in with id from resolved name
        man.data$resolved_id[counter] <- wm_name2id(name=unlist(man.data$resolved_names[counter]))
      }
    }
  } else {
    # else fill with NA 
    man.data$resolved_names[counter] <- NA_character_
    # check if international id is not empty for row 
    if(!is.na(man.data$international_id[counter])) {
      # check if id is same as manual
      test_name <- wm_id2name(id=man.data$international_id[counter])
      man.data$resolved_names[counter] <- test_name
      if (test_name == man.data$name[counter]) {
        # set resolved id to international id
        man.data$resolved_id[counter] <- man.data$international_id[counter]
      }
      else {
        # set resolved id from resolved name
        response <- taxize::get_wormsid_(
          test_name,
          searchtype = 'scientific',
          accepted = F,
          ask = F,
          messages = F
        ) 
        response <- as.data.frame(response)
        # check if response isn't empty 
        if (!empty(response)) {
          test_name <- gsub(" ", ".", test_name, fixed=TRUE)
          get.id <- paste(test_name, sep='.', "AphiaID")
          resolved_id <- response[1, get.id]
          man.data$resolved_id[counter] <- resolved_id
          # set resolved name tfdo resolved test_name
          man.data$resolved_names[counter] <- test_name
        }
      }
    } else {
      # fill ID with NA
      man.data$resolved_id[counter] <- NA_character_
      # check if id can be resolved with original, unresolved name
      test_name <- man.data$name[counter]
      response <- taxize::get_wormsid_(
        test_name,
        searchtype = 'scientific',
        accepted = F,
        ask = F,
        messages = F
      ) 
      response <- as.data.frame(response)
      # check if response isn't empty 
      if (!empty(response)) {
        test_name <- gsub(" ", ".", test_name, fixed=TRUE)
        get.id <- paste(test_name, sep='.', "AphiaID")
        resolved_id <- response[1, get.id]
        man.data$resolved_id[counter] <- resolved_id
        # set resolved name tfdo resolved test_name
        man.data$resolved_names[counter] <- test_name
      }
    }
  }
  counter <- counter + 1
}

# check worm ids with resolved names 
# test_name <- wm_id2name(id =120533)
# cat(test_name)
# 
# # set the resolved name if empty
# 'resolved_name' =  query[1, 'matched_name2']
```
